version: 2
jobs:
  build:
    docker:
      # First image listed on config.yml will be the "primary" image. Any build commands run in this container.
      - image: wordpress:4.9.1-php5.6-apache
        environment:
          WORDPRESS_DB_HOST: 127.0.0.1
          WORDPRESS_DB_NAME: wordpress
          WORDPRESS_DB_USER: root
          WORDPRESS_DB_PASSWORD: secretpwd

      # Second image listed here is the secondary container which runs in the same network of the primary container (they can connect as localhost)
      - image: mysql:5.6
        environment:
          MYSQL_ROOT_PASSWORD: secretpwd

    steps:
      - checkout
      - run:
          name: Update Packages
          command: 'apt-get update'
      - run:
          name: Install MySQL Client
          command: 'apt-get install -y mysql-client'
      - run:
          name: Create Wordpress database after server startup
          command: 'sleep 10 && mysql -uroot -p"${WORDPRESS_DB_PASSWORD}" -h"${WORDPRESS_DB_HOST}" -e "CREATE DATABASE wordpress charset utf8"'
     - run:
          name: Ensure that Apache starts on foreground (wrapper used by docker-entrypoint.sh)
          command: 'sed -i "s,-DFOREGROUND,,g" /usr/local/bin/apache2-foreground'
      - run:
          name: Install wp-cli
          command: 'apt-get -y install wget && wget https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -O /usr/bin/wp-cli && chmod +x /usr/bin/wp-cli'
      - run:
          name: Deploy Wordpress files (including wp-config.php)
          command: '/usr/local/bin/docker-entrypoint.sh apache2-foreground'
      - run:
          name: Install Wordpress automatically
          command: 'wp-cli core install --debug --allow-root --path=/root/project --url="http://localhost" --title="Wordpress" --admin_user=admin --admin_password="${WORDPRESS_DB_PASSWORD}" --admin_email="test@example.net"'
      - run:
          name: Check that Wordpress was installed
          command: 'mysql -u"${WORDPRESS_DB_USER}" -h"${WORDPRESS_DB_HOST}" -p"${WORDPRESS_DB_PASSWORD}" -D"${WORDPRESS_DB_NAME}" -e "SELECT * FROM wp_options"'
